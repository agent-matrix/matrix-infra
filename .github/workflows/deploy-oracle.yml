name: Deploy to Oracle VM

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ORACLE_KEY }}

      - name: Deploy services via SSH
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          echo "Deploying to $ORACLE_HOST as $ORACLE_USER"
          ssh -o StrictHostKeyChecking=no "$ORACLE_USER@$ORACLE_HOST" 'bash -s' <<'EOSSH'
            set -e
            # Change to the directory where matrix-infra is cloned on the VM.
            cd matrix-infra/platforms/oracle/compose
            git pull
            ./deploy.sh
          EOSSH

    # Note: This workflow assumes the matrix-infra repo is already cloned on the VM
    # at ~/matrix-infra.  Adjust paths as needed.  See docs/quickstart-oracle.md.